
# 2. Exploitation
## Lỗ hổng phần mềm
Là lỗi trong phần mềm (thiết kế, triển khai, vận hành), cho phép threat actor lợi dụng để thực hiện hành động trái phép lên dữ liệu. Nếu phân chia theo attack vector, bên cạnh việc đánh cắp dữ liệu hoặc làm gián đoạn hệ thống chúng ta có:
- Remote attack (tấn công từ xa): chiếm quyền kiểm soát hệ thống => Malware sử dụng để lây nhiễm thay vì đánh lừa người dùng qua phishing, hoặc đôi khi kết hợp để exploit phần mềm
- Local attack: leo thang đặc quyền -> thực hiện hành động dưới quyền của user khác. mục đích nhằm kiểm soát tài nguyên của user đó => Malware sử dụng để đánh cắp thông tin nhạy cảm trong hệ thống hoặc sửa đổi dữ liệu trong hệ thống.


## Khai thác lỗ hổng phần mềm dưới góc nhìn của threat actor:
- 0-day: lỗ hổng chưa biết (todo) pros and cons
  + Mới, chưa bị phát hiện, có thể có impact cao
  - mất thời gian nghiên cứu
  - Nếu malware bị phát hiện và phân tích, lỗ hổng cũng sẽ được khám phá
- Lỗ hổng đã biết (pros and cons)
  + Nhiều software sẽ không patch. Hoặc trong môi trường corp: sys admin không patch.
  + Có lượng thông tin nhất định để có thể viết exploit.
  + Có thể có biến thể chưa được phát hiện.
  - Bị detect bởi hệ thống bảo vệ.
  - Bị mitigate

# Tìm hiểu về target
Trong bài này, đặt scope nghiên cứu graybox / whitebox.

## Cài đặt Env
- Any linux in VM. (suggest lightweight Debian-based, use XFCE). Ubuntu + XFCE4 is okay
- Install Escan Antivirus 7.32 `https://escanav.com/en/antivirus-downloadlink/downloadproduct.asp?pcode=ES-LNHMv9&srsltid=AfmBOoqsrDzsFhMhB60s9YUNNKMZWPs-YpT4tiS5XnoTZ6kpE4yfIzdJ` (use Deb 64 bit) hoặc backup `https://drive.proton.me/urls/XJQKF172MC#u7qsftUdIoKl`, tải file `escan-antivirus-wks.amd64.deb`
- `sudo dpkg -i escan-antivirus-wks.amd64.deb` để cài.


## Tại sao target này:
- Av viết chất lượng kém, nhiều lỗ hổng (good target practice)
- AV được trusted bởi người dùng. Thực tế: AV cũng là software, và có lỗ hổng bảo mật. Nhiều thành phần của AV lại chạy ở quyền cao nhất trong hệ thống -> exploit
- AV được quảng cáo là bảo vệ người dùng khỏi 99%-100% các cuộc tấn công. Thực tế: Av chỉ detect những cuộc tấn công đã biết, và có thể detect những cuộc tấn công có dấu hiệu giống.

## Nghiên cứu thông tin phần mềm
TODO: Giải thích đây là cài đặt trên môi trường family của debian. Với cài đặt format khác (ví dụ rpm) sẽ có cách phân tích khác.
- Thông tin gói cài đặt (`apt` k show vì dùng `dpkg -i`):
  - `dpkg-deb -I escan-antivirus-wks.amd64.deb`. Có thể sử dụng ngắn hơn là `dpkg` tuy nhiên `dpkg-deb` show flag help. TODO tìm hiểu cách dpkg reference command để tránh confuse. Có thể dùng `ls -t /var/lib/dpkg/info/*.list | head -n 1` để lấy tên gói cài đặt cuối cùng.
  - Sử dụng `dpkg-deb -c ` để show list các danh sách file sẽ được cài đặt. Show file đã cài dùng `dpkg -L`, nó show giống `dpkg -c`. Content được lưu trong `/var/lib/dpkg/info/*.list`.
- Extra info:
  + pre-inst, post-inst, md5sum, ... 
  + `/opt/MicroWorld_7.0.32/` => missing. Why? (vấn đề gì với việc cài đặt)?
  => Nguyên nhân: `postinst` script chạy script `Install.sh`. Script `Install.sh` này thực hiện move folder từ `MicroWorld_${version}` về `MicroWorld`, kể cả trong `opt` lẫn `var`. TODO show line trong script.
  => không phải thông tin nào cũng được show hết. 1 số thông tin được thực hiện ngay sau cài đặt, hoặc được ghi runtime. 1 số cái còn bị sai
  + Cần kiểm tra cấu trúc file / folder. Cần kiểm tra cấu trúc những thành phần hệ thống bị sửa đổi (ví dụ service)

(Vài phương pháp tìm thông tin khác)
  + Thử tìm thông tin về installation thông qua systemd unit và init.d (cons: tên có thể khó hiểu -> khó xác định đúng)
    - Hiểu sự khác nhau giữa `service` và `systemctl`. Nói qua mớ sys init của Linux.
    - xem service đang chạy: `service --status-all` -> `[+]` == đang chạy, `[-]` == k chạy, (hoặc lỗi khi khởi chạy) => cách này chưa hiệu quả =>
      + list bằng `systemd-cgls` hoặc `systemctl list-unit-files --type=service --no-legend --no-pager`. Có thể kết hợp grep.
      + Filter bằng `for unit in $(systemctl list-unit-files --type=service --no-legend); do unit_data=$(systemctl show "$unit" --property=FragmentPath,Description,ExecStart 2>/dev/null); if echo $unit_data | grep -q "/opt/"; then echo "===" echo $unit_data; echo "---"; fi; done`
    - Tìm file unit (trong systemd hoặc systemctl) thông qua sort bởi time hoặc từ khóa (`grep -r /opt/`)
      - `grep -r /opt/ /etc/systemd/`
      - `ls -lt /etc/systemd/system/` -> bị lẫn với các service khác (nhưng biết service mới. Ví dụ keyword bị miss?)
  + Thử tìm thông tin về installation thông qua lệnh find (tìm file / folder name) (cons: chậm, cần biết pattern tên. Nếu tên khác: ví dụ eAV. Chứng minh là folter MicroWorld_7.0.32 miss)
  + Thử tìm thông tin thông qua desktop entry: (cons: chỉ biết location có binary, thiếu các phần ví dụ `/usr/lib/` hoặc trong `/var/`)
  + Kiểm tra thông qua lệnh ps

=>> Thu thập thông tin, biết được cài đặt trong `/opt/MicroWorld/` và các thông tin hữu ích khác. Xem và nhận định kiến trúc:
- Đâu là nơi chứa database (virus signature)
- Log (scan log, debug log)
- Những điểm đnág chú ý khác?

## enumeration
Tìm những điểm yếu thông qua 2 quá trình:
- Quá trình cài đặt: thay đổi tài nguyên trên hệ thống, gây ra tình trạng cấp thừa quyền => Sử dụng script trong phần post-exploit
  - SUID:
  ```
  /opt/MicroWorld/sbin/commonutil
  /opt/MicroWorld/sbin/runasroot
  ```
  - Writable dir: Lưu ý mấy thư mục kiểu
  ```
  /opt/MicroWorld/var/bdplugins1
  /opt/MicroWorld/var/bdplugins2
  ...
  /var/MicroWorld/var/
  ```
- Quá trình vận hành: Tiến trình, dịch vụ đang được chạy có thể sử dụng làm mục tiêu để tấn công:
  + `rtscanner`
  + `epsdaemon`: lib missing. tính sẵn sàng không cao (kể cả đang chạy)
  + GUI chạy bằng admin / root (có nhưng tính sẵn sàng không cao)

# Vector 1: Attack chain
Root-cause:
- Cấp thừa quyền access cho folder
- Tiến trình xử lý không an toàn

Practice
- Dịch ngược, phân tích và viết exploit leo thang đặc quyền bằng cách chain CVE-2024-13188 và CVE-2025-0720
 + Sử dụng strace để xem việc `rtscanner` gọi các thư viện
 + Từ kết quả, kết hợp với kết quả enumerate, phân tích hướng thực hiện và viết exploit
 + Kết hợp với CVE-2025-0720 để trigger lỗ hổng

# Vector 2: Exploit logic
Root-cause:
+ Lỗi trong logic comparison
+ Design flaw: `runasroot` được thiết kế để chạy một số lệnh / chương trình nhất định như `chown`, `chmod` để sửa quyền/ower của một số file (được whitelist); `checkpassdesktop` để thực hiện một số tác vụ. Chương trình này, theo lý thuyết chỉ được chạy bằng `root` hoặc user `XXX` được add bởi escan
  - các file được sửa bao gồm cả cron
  - Một số chương trình gọi lên đã có sẵn quyền root -> việc sử dụng là không cần thiết
  TODO: chứng minh thêm về design flaw, thừa quyền và chứng minh có cách thực hiện khác.

Practice:
- Dịch ngược, phân tích `runasroot`
 + Hiểu logic code của việc cho phép thực thi lệnh chmod
 + Hiểu bug gây ra lỗ hổng cho phép thực thi ngoài ý muốn
 + Viết script khai thác lỗ hổng leo thang đặc quyền


# vector 3: CVE-2025-0798
Root-cause: chương trình xử lý input không an toàn


3. Bài tập:
- Phân tích và viết script khai thác CVE-2025-0798
- Viết script kiểm tra các lỗ hổng có thể tồn tại hay không? (ví dụ: dựa vào version patch, dựa vào một số artifact, ...).
- Bonus: viết module exploit cho Metasploit
